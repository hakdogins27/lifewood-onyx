<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Lifewood</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap');
        :root {
            --brand-primary: #FFB347; --brand-dark: #133020; --brand-green: #046241;
            --bg-light: #f5eedb; --bg-card: #ffffff; --text-primary: #1f2937;
            --text-secondary: #6b7280; --border-color: #e5e7eb; --danger-bg: #fee2e2;
            --danger-text: #991b1b; --danger-main: #dc2626; --success-bg: #dcfce7; --success-text: #166534;
            --bg-subtle: #f8f9fa;
        }
        body { font-family: 'Manrope', sans-serif; background-color: var(--bg-light); color: var(--text-primary); margin: 0; }
        .dashboard-container { display: flex; height: 100vh; }
        .sidebar { width: 260px; background-color: var(--brand-dark); color: #f3f4f6; padding: 24px; display: flex; flex-direction: column; flex-shrink: 0; }
        .main-content { flex-grow: 1; padding: 32px; overflow-y: auto; }
        .sidebar .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; color: var(--brand-primary); margin-bottom: 40px; }
        .sidebar .logo-text { font-size: 28px; font-weight: 800; }
        .sidebar-nav h3 { font-size: 12px; text-transform: uppercase; color: #9ca3af; letter-spacing: 0.5px; margin: 24px 0 12px 0; }
        .sidebar-nav .nav-link { display: flex; justify-content: space-between; align-items: center; color: #d1d5db; text-decoration: none; padding: 10px 12px; border-radius: 6px; margin-bottom: 4px; font-weight: 500; transition: background-color 0.2s, color 0.2s, font-weight 0.2s; cursor: pointer; }
        .sidebar-nav .nav-link:hover { background-color: rgba(255, 255, 255, 0.1); color: white; }
        .sidebar-nav .nav-link.active { background-color: var(--brand-primary); color: var(--brand-dark); font-weight: 700; }
        .notification-badge {
            background-color: var(--danger-main);
            color: white;
            font-size: 12px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 12px;
            display: none;
        }
        /* Renamed for clarity: applies to both apps and inquiries */
        .sidebar-nav .nav-link.has-new-items {
            font-weight: 800;
        }

        .sidebar-footer { margin-top: auto; }
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; }
        #main-title { font-size: 32px; font-weight: 800; color: var(--brand-green); margin: 0; }
        .controls-container { display: none; gap: 16px; align-items: center; margin-left: auto; }
        #bulk-action-controls { display: none; align-items: center; gap: 12px; border-right: 2px solid var(--border-color); padding-right: 16px; }
        #select-all-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .btn-danger { background-color: var(--danger-bg); color: var(--danger-text); }
        .btn-danger:hover { background-color: #fecaca; }
        .search-wrapper { position: relative; }
        #search-input { padding: 10px 15px 10px 40px; border-radius: 6px; border: 1px solid var(--border-color); font-family: 'Manrope', sans-serif; font-size: 14px; width: 250px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%236b7280" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>'); background-repeat: no-repeat; background-position: 12px center; background-size: 16px; }
        .filter-select { padding: 10px 15px; border-radius: 6px; border: 1px solid var(--border-color); background-color: white; font-family: 'Manrope', sans-serif; font-size: 14px; font-weight: 600; color: var(--text-secondary); cursor: pointer; }
        .view-container { display: none; }
        .applications-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .applicant-card { background-color: var(--bg-card); border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); border: 1px solid var(--border-color); }
        .main-row { display: flex; align-items: center; padding: 20px 24px; gap: 20px; }
        .applicant-checkbox { width: 18px; height: 18px; cursor: pointer; flex-shrink: 0; }
        .main-row-content { flex-grow: 1; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .applicant-info { display: flex; align-items: baseline; gap: 16px; }
        .applicant-name { font-weight: 700; font-size: 18px; }
        .applicant-position { color: var(--text-secondary); font-weight: 500; font-size: 16px; }
        .status-badge { padding: 6px 12px; border-radius: 16px; font-weight: 600; font-size: 12px; text-transform: capitalize; }
        .status-received { background-color: #e0e0e0; color: #333; }
        .status-under-review { background-color: #dbeafe; color: #1e40af; }
        .status-interview-scheduled { background-color: #e9d5ff; color: #581c87; }
        .status-offer-extended { background-color: #ffedd5; color: #9a3412; }
        .status-hired { background-color: var(--success-bg); color: var(--success-text); }
        .status-rejected { background-color: var(--danger-bg); color: var(--danger-text); }
        .details-row { padding: 24px; border-top: 1px solid var(--border-color); background-color: #fff; }
        .details-wrapper { display: flex; flex-wrap: wrap; gap: 32px; }
        .details-main-content { flex: 2; min-width: 300px; }
        .details-admin-panel { flex: 1; min-width: 280px; background-color: var(--bg-subtle); padding: 24px; border-radius: 8px; border: 1px solid var(--border-color); height: fit-content; }
        .details-section-title { font-size: 16px; font-weight: 700; color: var(--brand-green); margin: 0 0 16px 0; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }
        .details-grid-3-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .details-grid-3-col p, .admin-panel-item p { margin: 0; }
        .details-grid-3-col strong, .admin-panel-item strong { display: block; font-size: 12px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px; }
        .details-grid-3-col span, .admin-panel-item span { font-size: 14px; color: var(--text-primary); word-break: break-word; }
        .experience-box { border: 1px solid var(--border-color); border-radius: 6px; padding: 16px; font-size: 14px; color: var(--text-primary); white-space: pre-wrap; }
        .admin-panel-item { margin-bottom: 20px; }
        .admin-panel-item label { display: block; font-size: 14px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; }
        .admin-panel-item select, .admin-panel-item textarea { width: 100%; box-sizing: border-box; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-family: 'Manrope', sans-serif; font-size: 14px; }
        .admin-panel-actions { display: flex; flex-direction: column; gap: 10px; }
        .admin-panel-actions .btn { width: 100%; }
        .admin-panel-actions .btn-text-danger { margin-top: 10px; text-align: center; }
        .placeholder-text { color: var(--text-secondary); font-style: italic; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s; font-family: 'Manrope', sans-serif; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--brand-primary); color: var(--brand-dark); }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-text-danger { background: none; color: var(--text-secondary); font-weight: 600; padding: 5px; }
        .btn-text-danger:hover { color: var(--danger-text); background-color: #fee2e2; }
        .list-view-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-card); padding: 20px 24px; border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--border-color); }
        .list-view-item .item-content { flex-grow: 1; }
        .list-view-item .position-title { font-weight: 700; font-size: 18px; color: var(--text-primary); }
        .add-item-form { display: flex; gap: 12px; margin-bottom: 24px; padding: 20px; background-color: var(--bg-card); border-radius: 8px; }
        .add-item-form input { flex-grow: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-family: 'Manrope', sans-serif; font-size: 16px; }
        .inquiry-header { display: flex; align-items: baseline; gap: 8px; }
        .inquiry-name { font-weight: 700; font-size: 18px; }
        .inquiry-email { font-size: 16px; color: var(--text-secondary); }
        .inquiry-message { margin: 8px 0; color: var(--text-primary); font-size: 14px; }
        .inquiry-timestamp { font-size: 12px; color: var(--text-secondary); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 30px; width: 90%; max-width: 500px; border-radius: 8px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: var(--brand-green); }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-body .form-group { margin-bottom: 15px; }
        .modal-body label { display: block; font-weight: 600; margin-bottom: 8px; }
        .modal-body input { width: 100%; box-sizing: border-box; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-family: 'Manrope', sans-serif; font-size: 16px; }
        .modal-footer { margin-top: 30px; text-align: right; }
        #toast { position: fixed; bottom: 20px; right: -500px; padding: 16px 24px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 600; transition: right 0.5s ease-in-out; z-index: 100; }
        #toast.show { right: 20px; }
        #toast.success { background-color: var(--success-bg); color: var(--success-text); }
        #toast.error { background-color: var(--danger-bg); color: var(--danger-text); }
        #dashboard-view { display: flex; flex-direction: column; gap: 24px; }
        .rating-stars { display: flex; cursor: pointer; gap: 4px; }
        .rating-stars .star { font-size: 24px; color: var(--border-color); transition: color 0.2s; }
        .rating-stars .star:hover { color: #ffd99a; }
        .rating-stars .star.filled { color: var(--brand-primary); }
        .save-rating-btn { margin-top: 10px; }
        .dashboard-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; background-color: var(--bg-card); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); text-align: center; }
        .summary-item .count { display: block; font-size: 28px; font-weight: 800; color: var(--brand-green); }
        .summary-item .label { font-size: 14px; font-weight: 600; color: var(--text-secondary); text-transform: capitalize; }
        .graph-container { background-color: var(--bg-card); padding: 24px; border-radius: 8px; border: 1px solid var(--border-color); }
        .graph-container h3 { font-size: 20px; font-weight: 700; color: var(--brand-green); margin-top: 0; margin-bottom: 16px; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <a href="index.html" class="logo"><svg class="logo-icon" width="24" height="42" viewBox="0 0 24 42" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 0L23.5962 10.5V31.5L12 42L0.403847 31.5V10.5L12 0Z" fill="currentColor"/></svg><span class="logo-text">lifewood</span></a>
            <nav class="sidebar-nav">
                <h3>Applications</h3>
                <a class="nav-link active" data-view="dashboard"><span>Dashboard</span></a>
                <a class="nav-link" data-filter="*">
                    <span>All Applications</span>
                    <span id="all-apps-notification-badge" class="notification-badge"></span>
                </a>
                <a class="nav-link" data-filter="Received">
                    <span>New</span>
                    <span id="new-apps-notification-badge" class="notification-badge"></span>
                </a>
                <a class="nav-link" data-filter="Interview Scheduled"><span>Interviewing</span></a>
                <a class="nav-link" data-filter="Hired"><span>Hired</span></a>
                <a class="nav-link" data-filter="Rejected"><span>Rejected</span></a>
                <h3>Content</h3>
                <a class="nav-link" data-view="positions"><span>Manage Positions</span></a>
                <a class="nav-link" data-view="inquiries">
                    <span>View Inquiries</span>
                    <span id="inquiries-notification-badge" class="notification-badge"></span>
                </a>
            </nav>
            <div class="sidebar-footer"><button id="logout-btn" class="btn btn-secondary">Logout</button></div>
        </aside>
        <main class="main-content">
            <header class="main-header">
                <h1 id="main-title">Dashboard</h1>
                <div id="controls-container" class="controls-container">
                    <div id="bulk-action-controls">
                        <input type="checkbox" id="select-all-checkbox" title="Select all visible applications">
                        <button id="delete-selected-btn" class="btn btn-danger">Delete (<span id="selected-count">0</span>)</button>
                    </div>
                    <div class="search-wrapper"><input type="text" id="search-input" placeholder="Search by name, position..."></div>
                    <select id="sort-select" class="filter-select">
                        <option value="date-desc">Sort by Date (Newest)</option>
                        <option value="date-asc">Sort by Date (Oldest)</option>
                        <option value="name-asc">Sort by Name (A-Z)</option>
                        <option value="name-desc">Sort by Name (Z-A)</option>
                    </select>
                    <select id="position-filter-select" class="filter-select">
                        <option value="all">All Positions</option>
                    </select>
                </div>
                <div id="toast" class="toast"></div>
            </header>
            <div id="dashboard-view" class="view-container"></div>
            <div id="applications-view" class="view-container applications-grid"></div>
            <div id="positions-view" class="view-container"></div>
            <div id="inquiries-view" class="view-container"></div>
        </main>
    </div>

    <div id="interview-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Schedule Interview</h2><span class="close-btn">×</span></div>
            <div class="modal-body">
                <div class="form-group"><label for="interview-start-time-input">Start Time:</label><input type="datetime-local" id="interview-start-time-input"></div>
                <div class="form-group"><label for="interview-end-time-input">End Time:</label><input type="datetime-local" id="interview-end-time-input"></div>
            </div>
            <div class="modal-footer"><button id="confirm-interview-btn" class="btn btn-primary">Confirm & Send Email</button></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAXzjkyXV2FMI2d_M9YTiZQdG0WNG1WbDs",
            authDomain: "lifewood-applicants-aa9bc.firebaseapp.com",
            projectId: "lifewood-applicants-aa9bc",
            storageBucket: "lifewood-applicants-aa9bc.firebasestorage.app",
            messagingSenderId: "772352846931",
            appId: "1:772352846931:web:2e824791e47c27a1f12aa6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        firebase.auth().onAuthStateChanged(user => {
            if (user) { user.getIdToken().then(token => initializeDashboard(token)); }
            else { window.location.href = 'admin_login.html'; }
        });
        
        async function initializeDashboard(token) {
            const mainTitle = document.getElementById('main-title');
            const viewContainers = { 
                dashboard: document.getElementById('dashboard-view'),
                applications: document.getElementById('applications-view'), 
                positions: document.getElementById('positions-view'), 
                inquiries: document.getElementById('inquiries-view') 
            };
            const controlsContainer = document.getElementById('controls-container');
            const searchInput = document.getElementById('search-input');
            const sortSelect = document.getElementById('sort-select');
            const positionFilterSelect = document.getElementById('position-filter-select');
            const bulkActionControls = document.getElementById('bulk-action-controls');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const deleteSelectedBtn = document.getElementById('delete-selected-btn');
            const selectedCountSpan = document.getElementById('selected-count');
            
            let allApplications = [];
            let allInquiries = [];
            let selectedApplications = new Set();
            let applicationsListener = null;
            let inquiriesListener = null;
            let applicationTrendChart = null;

            const interviewModal = document.getElementById('interview-modal');
            const confirmInterviewBtn = document.getElementById('confirm-interview-btn');
            const interviewStartTimeInput = document.getElementById('interview-start-time-input');
            const interviewEndTimeInput = document.getElementById('interview-end-time-input');
            const closeBtn = interviewModal.querySelector('.close-btn');

            const showToast = (message, isError = false) => {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast show ${isError ? 'error' : 'success'}`;
                setTimeout(() => { toast.className = 'toast'; }, 2000);
            };

            const handleApiAction = async (endpoint, options = {}) => {
                const defaultOptions = { headers: { 'Authorization': `Bearer ${token}` } };
                if (!(options.body instanceof FormData) && options.body) {
                    defaultOptions.headers['Content-Type'] = 'application/json';
                }
                try {
const response = await fetch(endpoint, { ...defaultOptions, ...options });
                    if (!response.ok) { const err = await response.json(); throw new Error(err.message || 'API error'); }
                    return response.json();
                } catch (error) { showToast(error.message, true); return null; }
            };
            
            const populatePositionFilter = (apps) => {
                const positions = [...new Set(apps.map(app => app.position).filter(Boolean))];
                positionFilterSelect.innerHTML = '<option value="all">All Positions</option>';
                positions.forEach(pos => {
                    const option = document.createElement('option');
                    option.value = pos;
                    option.textContent = pos;
                    positionFilterSelect.appendChild(option);
                });
            };

            const updateBulkActionControls = () => {
                const count = selectedApplications.size;
                bulkActionControls.style.display = count > 0 ? 'flex' : 'none';
                selectedCountSpan.textContent = count;
                const visibleCheckboxes = [...viewContainers.applications.querySelectorAll('.applicant-checkbox')];
                const allVisibleSelected = visibleCheckboxes.length > 0 && visibleCheckboxes.every(cb => cb.checked);
                selectAllCheckbox.checked = allVisibleSelected;
                selectAllCheckbox.indeterminate = count > 0 && !allVisibleSelected;
            };

            const displayApplications = () => {
                let filteredApps = [...allApplications];
                const statusFilter = document.querySelector('.sidebar-nav .nav-link.active')?.dataset.filter || '*';
                const searchTerm = searchInput.value.toLowerCase();
                const sortValue = sortSelect.value;
                const positionFilter = positionFilterSelect.value;

                if (statusFilter !== '*') {
                    filteredApps = filteredApps.filter(app => (app.status || 'Received') === statusFilter);
                }
                if (positionFilter !== 'all') {
                    filteredApps = filteredApps.filter(app => app.position === positionFilter);
                }
                if (searchTerm) {
                    filteredApps = filteredApps.filter(app => 
                        `${app.firstName || ''} ${app.lastName || ''}`.toLowerCase().includes(searchTerm) ||
                        (app.position || '').toLowerCase().includes(searchTerm)
                    );
                }
                filteredApps.sort((a, b) => {
                    switch (sortValue) {
                        case 'name-asc': return (a.firstName || '').localeCompare(b.firstName || '');
                        case 'name-desc': return (b.firstName || '').localeCompare(a.firstName || '');
                        case 'date-asc': return (a.submittedAt?.seconds || 0) - (b.submittedAt?.seconds || 0);
                        default: return (b.submittedAt?.seconds || 0) - (a.submittedAt?.seconds || 0);
                    }
                });
                renderApplications(filteredApps);
                updateBulkActionControls();
            };

            const renderApplications = (apps) => {
                const container = viewContainers.applications;
                container.innerHTML = !apps || apps.length === 0 ? '<p>No applications match the current filters.</p>' : '';
                if (!apps || apps.length === 0) return;

                const statusOptions = ['Under Review', 'Interview Scheduled', 'Offer Extended', 'Hired', 'Rejected'];
                apps.forEach(app => {
                    const currentStatus = app.status || 'Received';
                    const submittedDate = app.submittedAt?.seconds ? new Date(app.submittedAt.seconds * 1000).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }) : 'Processing...';
                    const portfolioLink = app.resumeLink ? `<a href="${app.resumeLink.startsWith('http') ? '' : '//'}${app.resumeLink}" target="_blank" rel="noopener noreferrer">${app.resumeLink}</a>` : '<span class="placeholder-text">Not Provided</span>';
                    const uploadedResumeLink = app.uploadedResumeUrl ? `<a href="${app.uploadedResumeUrl}" target="_blank" rel="noopener noreferrer">View Uploaded Resume</a>` : '<span class="placeholder-text">Not Provided</span>';
                    const availability = (app.startTime && app.endTime) ? `${app.startTime} to ${app.endTime}` : '<span class="placeholder-text">Not Provided</span>';
                    const rating = app.rating || 0;
                    let starsHTML = Array.from({length: 5}, (_, i) => `<span class="star ${i < rating ? 'filled' : ''}" data-value="${i + 1}">★</span>`).join('');

                    const card = document.createElement('div');
                    card.className = 'applicant-card';
                    card.dataset.id = app.id;
                    card.innerHTML = `
                        <div class="main-row">
                            <input type="checkbox" class="applicant-checkbox" data-id="${app.id}" title="Select this application" ${selectedApplications.has(app.id) ? 'checked' : ''}>
                            <div class="main-row-content">
                                <div class="applicant-info"><span class="applicant-name">${app.firstName || 'No Name'} ${app.lastName || ''}</span><span class="applicant-position">${app.position || 'No Position'}</span></div>
                                <div class="applicant-status"><span class="status-badge status-${currentStatus.toLowerCase().replace(/\s+/g, '-')}">${currentStatus}</span></div>
                            </div>
                        </div>
                        <div class="details-row" style="display: none;">
                            <div class="details-wrapper">
                                <div class="details-main-content">
                                    <h4 class="details-section-title">Applicant Details</h4>
                                    <div class="details-grid-3-col">
                                        <p><strong>Email</strong><span><a href="mailto:${app.email || ''}">${app.email || 'N/A'}</a></span></p>
                                        <p><strong>Age</strong><span>${app.age || 'N/A'}</span></p>
                                        <p><strong>Degree</strong><span>${app.degree || 'N/A'}</span></p>
                                        <p><strong>Availability</strong><span>${availability}</span></p>
                                        <p><strong>Portfolio/Link</strong><span>${portfolioLink}</span></p>
                                        <p><strong>Uploaded Resume</strong><span>${uploadedResumeLink}</span></p>
                                    </div>
                                    <h4 class="details-section-title">Job Experience</h4>
                                    <div class="experience-box">${app.experience || '<span class="placeholder-text">Not Provided</span>'}</div>
                                </div>
                                <div class="details-admin-panel">
                                    <div class="admin-panel-item"><p><strong>Submitted</strong><span>${submittedDate}</span></p></div>
                                    <div class="admin-panel-item"><label>Rate Applicant</label><div class="rating-stars" data-id="${app.id}" data-current-rating="${rating}">${starsHTML}</div><button class="btn btn-secondary save-rating-btn">Save Rating</button></div>
                                    <div class="admin-panel-item"><label for="notes-${app.id}">Notes</label><textarea id="notes-${app.id}" placeholder="Add private notes...">${app.notes || ''}</textarea></div>
                                    <div class="admin-panel-item"><label for="status-select-${app.id}">Change Status</label><select id="status-select-${app.id}">${statusOptions.map(o => `<option value="${o}" ${currentStatus === o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>
                                    <div class="admin-panel-actions"><button class="btn btn-secondary save-notes-btn">Save Notes</button><button class="btn btn-primary save-status-btn">Save Status</button><button class="btn btn-text-danger delete-btn">Delete Application</button></div>
                                </div>
                            </div>
                        </div>`;
                    container.appendChild(card);
                });
            };

            const renderApplicationTrendGraph = (trendData) => {
                const ctx = document.getElementById('applicationTrendChart').getContext('2d');
                if (applicationTrendChart) applicationTrendChart.destroy();
                const statusColors = {'Hired': '#15803d', 'Interview Scheduled': '#FFB347', 'Rejected': '#FDBA74', 'Other': '#A7D7C5'};
                applicationTrendChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: trendData.labels.map(label => new Date(label + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                        datasets: trendData.datasets.map(dataset => ({...dataset, backgroundColor: statusColors[dataset.label] || '#a8a29e', borderRadius: 4}))
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 }}}, plugins: { legend: { display: true, position: 'top' }}}
                });
            };

            const renderDashboardView = async () => {
                const summaryCounts = { total: allApplications.length, pending: 0, interviewing: 0, hired: 0, rejected: 0 };
                allApplications.forEach(app => {
                    const status = app.status || 'Received';
                    if (status === 'Received') summaryCounts.pending++;
                    else if (status === 'Interview Scheduled') summaryCounts.interviewing++;
                    else if (status === 'Hired') summaryCounts.hired++;
                    else if (status === 'Rejected') summaryCounts.rejected++;
                });

                viewContainers.dashboard.innerHTML = `
                    <div class="dashboard-summary">
                        <div class="summary-item"><span class="count">${summaryCounts.total}</span><span class="label">Total</span></div>
                        <div class="summary-item"><span class="count">${summaryCounts.pending}</span><span class="label">Pending</span></div>
                        <div class="summary-item"><span class="count">${summaryCounts.interviewing}</span><span class="label">Interviewing</span></div>
                        <div class="summary-item"><span class="count">${summaryCounts.hired}</span><span class="label">Hired</span></div>
                        <div class="summary-item"><span class="count">${summaryCounts.rejected}</span><span class="label">Rejected</span></div>
                    </div>
                    <div class="graph-container">
                        <h3>Application Status (Last 7 Days)</h3>
                        <div style="height: 300px;"><canvas id="applicationTrendChart"></canvas></div>
                    </div>`;
                
                const trendData = await handleApiAction('/api/analytics/application-trends');
                if (trendData) renderApplicationTrendGraph(trendData);
            };
            
            function listenForApplications() {
                if (applicationsListener) applicationsListener();
                applicationsListener = db.collection("applications").orderBy("submittedAt", "desc").onSnapshot(querySnapshot => {
                    allApplications = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const activeView = document.querySelector('.sidebar-nav .nav-link.active')?.dataset.view;
                    if (activeView === 'dashboard') renderDashboardView();
                    else { populatePositionFilter(allApplications); displayApplications(); }
                }, error => { console.error("Error listening for applications:", error); showToast("Could not connect to applications database.", true); });
            }

            const fetchAndRenderPositions = async () => {
                const positions = await handleApiAction('/api/positions');
                const container = viewContainers.positions;
                container.innerHTML = `<div class="add-item-form"><input type="text" id="position-title-input" placeholder="New position title..."><button id="add-position-btn" class="btn btn-primary">Add Position</button></div>`;
                if(positions) container.innerHTML += positions.map(p => `<div class="list-view-item"><span class="position-title">${p.title}</span><button class="btn btn-secondary delete-btn" data-id="${p.id}" data-type="position">Delete</button></div>`).join('');
            };
            
            const renderInquiries = (inquiries) => {
                const container = viewContainers.inquiries;
                container.innerHTML = !inquiries || inquiries.length === 0 ? '<p>There are no contact inquiries.</p>' : 
                    inquiries.map(i => `
                        <div class="list-view-item">
                            <div class="item-content">
                                <div class="inquiry-header"><span class="inquiry-name">${i.name}</span><span class="inquiry-email">(${i.email})</span></div>
                                <p class="inquiry-message">${i.message}</p>
                                <small class="inquiry-timestamp">${i.submittedAt?.seconds ? new Date(i.submittedAt.seconds * 1000).toLocaleString() : 'Processing...'}</small>
                            </div>
                            <button class="btn btn-secondary delete-btn" data-id="${i.id}" data-type="inquiry">Delete</button>
                        </div>`
                    ).join('');
            };

            function listenForInquiries() {
                if (inquiriesListener) inquiriesListener();
                inquiriesListener = db.collection("inquiries").orderBy("submittedAt", "desc").onSnapshot(querySnapshot => {
                    allInquiries = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderInquiries(allInquiries);
                }, error => { console.error("Error listening for inquiries:", error); showToast("Could not connect to inquiries database.", true); });
            }

            function listenForApplicationNotifications() {
                const allAppsLink = document.querySelector('.nav-link[data-filter="*"]');
                const newAppsLink = document.querySelector('.nav-link[data-filter="Received"]');
                const allAppsBadge = document.getElementById('all-apps-notification-badge');
                const newAppsBadge = document.getElementById('new-apps-notification-badge');

                db.collection("applications").where("viewed", "==", false)
                    .onSnapshot(snapshot => {
                        const newCount = snapshot.size;
                        const hasNew = newCount > 0;
                        allAppsLink.classList.toggle('has-new-items', hasNew);
                        newAppsLink.classList.toggle('has-new-items', hasNew);
                        [allAppsBadge, newAppsBadge].forEach(badge => {
                            badge.textContent = newCount;
                            badge.style.display = hasNew ? 'inline-block' : 'none';
                        });
                    }, error => console.error("Error listening for application notifications: ", error));
            }

            function listenForInquiryNotifications() {
                const inquiriesNavLink = document.querySelector('.nav-link[data-view="inquiries"]');
                const notificationBadge = document.getElementById('inquiries-notification-badge');
                db.collection("inquiries").where("viewed", "==", false)
                    .onSnapshot(snapshot => {
                        const newCount = snapshot.size;
                        inquiriesNavLink.classList.toggle('has-new-items', newCount > 0);
                        notificationBadge.textContent = newCount;
                        notificationBadge.style.display = newCount > 0 ? 'inline-block' : 'none';
                    }, error => console.error("Error listening for inquiry notifications: ", error));
            }

            const switchView = async (linkElement) => {
                if (!linkElement) return;
                mainTitle.textContent = linkElement.querySelector('span').textContent;
                document.querySelectorAll('.sidebar-nav .nav-link').forEach(l => l.classList.remove('active'));
                linkElement.classList.add('active');
                
                const view = linkElement.dataset.view;
                const filter = linkElement.dataset.filter;

                Object.values(viewContainers).forEach(c => c.style.display = 'none');
                controlsContainer.style.display = 'none';
                if (applicationsListener) { applicationsListener(); applicationsListener = null; }
                if (inquiriesListener) { inquiriesListener(); inquiriesListener = null; }
                
                if (view === 'dashboard') {
                    viewContainers.dashboard.style.display = 'flex';
                    listenForApplications();
                } else if (filter) {
                    viewContainers.applications.style.display = 'grid';
                    controlsContainer.style.display = 'flex';
                    await handleApiAction('/api/applications/mark-as-read', { method: 'POST' });
                    listenForApplications();
                } else if (view) {
                    viewContainers[view].style.display = 'block';
                    if (view === 'positions') fetchAndRenderPositions();
                    if (view === 'inquiries') {
                        await handleApiAction('/api/inquiries/mark-as-read', { method: 'POST' });
                        listenForInquiries();
                    }
                }
            };

            closeBtn.onclick = () => interviewModal.style.display = 'none';
            window.onclick = (e) => { if (e.target == interviewModal) interviewModal.style.display = 'none'; };

            confirmInterviewBtn.addEventListener('click', async () => {
                const id = confirmInterviewBtn.dataset.id;
                const startTime = interviewStartTimeInput.value;
                const endTime = interviewEndTimeInput.value;
                if (!startTime || !endTime) { showToast('Please select both a start and end time.', true); return; }
                const result = await handleApiAction(`/api/application/${id}`, { method: 'PUT', body: JSON.stringify({ status: 'Interview Scheduled', interviewStartTime: startTime, interviewEndTime: endTime }) });
                if (result) { showToast(result.message); interviewModal.style.display = 'none'; }
            });

            document.querySelectorAll('.sidebar-nav .nav-link').forEach(link => {
                link.addEventListener('click', (e) => switchView(e.target.closest('.nav-link')));
            });

            [searchInput, sortSelect, positionFilterSelect].forEach(el => el.addEventListener('input', displayApplications));
            
            selectAllCheckbox.addEventListener('change', () => {
                const isChecked = selectAllCheckbox.checked;
                viewContainers.applications.querySelectorAll('.applicant-checkbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                    if (isChecked) selectedApplications.add(checkbox.dataset.id);
                    else selectedApplications.delete(checkbox.dataset.id);
                });
                updateBulkActionControls();
            });

            deleteSelectedBtn.addEventListener('click', async () => {
                const count = selectedApplications.size;
                if (count > 0 && confirm(`Are you sure you want to permanently delete ${count} application(s)?`)) {
                    await Promise.all([...selectedApplications].map(id => handleApiAction(`/api/application/${id}`, { method: 'DELETE' })));
                    showToast(`Successfully deleted ${count} application(s).`);
                    selectedApplications.clear();
                }
            });

            viewContainers.applications.addEventListener('click', e => {
                const checkbox = e.target.closest('.applicant-checkbox');
                if (checkbox) {
                    if (checkbox.checked) selectedApplications.add(checkbox.dataset.id);
                    else selectedApplications.delete(checkbox.dataset.id);
                    updateBulkActionControls();
                    return;
                }
                const content = e.target.closest('.main-row-content');
                if (content) {
                    const detailsRow = content.closest('.applicant-card').querySelector('.details-row');
                    detailsRow.style.display = detailsRow.style.display === 'none' ? 'block' : 'none';
                }
            });

            document.body.addEventListener('click', async (e) => {
                const target = e.target;
                if (target.id === 'add-position-btn') {
                    const titleInput = document.getElementById('position-title-input');
                    if (titleInput.value) {
                        const result = await handleApiAction('/api/positions', { method: 'POST', body: JSON.stringify({ title: titleInput.value }) });
                        if(result) { showToast(result.message); fetchAndRenderPositions(); }
                    }
                } else if (target.matches('.rating-stars .star')) {
                    const ratingContainer = target.parentElement;
                    const ratingValue = target.dataset.value;
                    ratingContainer.dataset.currentRating = ratingValue;
                    ratingContainer.querySelectorAll('.star').forEach(s => s.classList.toggle('filled', s.dataset.value <= ratingValue));
                } else if (target.closest('.applicant-card')) {
                    const card = target.closest('.applicant-card');
                    const id = card.dataset.id;
                    if (target.matches('.save-status-btn')) {
                        const newStatus = card.querySelector(`#status-select-${id}`).value;
                        if (newStatus === 'Interview Scheduled') {
                            confirmInterviewBtn.dataset.id = id;
                            interviewModal.style.display = 'flex';
                        } else {
                            const result = await handleApiAction(`/api/application/${id}`, { method: 'PUT', body: JSON.stringify({ status: newStatus }) });
                            if (result) showToast(result.message);
                        }
                    } else if (target.matches('.save-notes-btn')) {
                        const result = await handleApiAction(`/api/application/${id}`, { method: 'PUT', body: JSON.stringify({ notes: card.querySelector(`#notes-${id}`).value }) });
                        if (result) showToast(result.message);
                    } else if (target.matches('.save-rating-btn')) {
                        const rating = parseInt(card.querySelector('.rating-stars').dataset.currentRating, 10);
                        const result = await handleApiAction(`/api/application/${id}`, { method: 'PUT', body: JSON.stringify({ rating: rating }) });
                        if(result) showToast(result.message);
                    } else if (target.matches('.delete-btn') && confirm('Delete this application permanently?')) {
                        await handleApiAction(`/api/application/${id}`, { method: 'DELETE' });
                    }
                } else if (target.matches('.delete-btn[data-type]')) {
                    const {type, id} = target.dataset;
                    if (confirm(`Delete this ${type}?`)) {
                        const result = await handleApiAction(`/api/${type}s/${id}`, { method: 'DELETE' });
                        if (result) showToast(result.message);
                    }
                }
            });

            document.getElementById('logout-btn').addEventListener('click', () => { firebase.auth().signOut(); });
            
            // Start both notification listeners
            listenForApplicationNotifications();
            listenForInquiryNotifications();
            // Initial view load
            switchView(document.querySelector('.sidebar-nav .nav-link.active'));
        }
    </script>
</body>
</html>